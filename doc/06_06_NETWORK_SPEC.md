# ネットワーク層機能仕様

## 概要

ネットワーク層は、永続化層からの要求を受けてDB層へのHTTPリクエストを生成し、レスポンスを解析して永続化層に返す責務を持ちます。

### 設計意図

1. **テスト容易性の向上**: 永続化層に対してDIに類似した手法でネットワーク層の実装を注入可能とし、モックやスタブへの差し替えを容易にします。
2. **エラー抽象化**: HTTPレスポンスの多様なエラー状態を、上位層で扱いやすい数種類のエラー種別に統一的に変換します。

### 基本動作

ネットワーク層は、DB層のREST APIエンドポイントに対してGET/PUT/POSTリクエストを発行します。PUT/POSTリクエストにはJSONボディを含めます。

すべてのレスポンスはJSONボディを期待し、以下の順序でパース処理を行います:

1. **成功レスポンスのパース**: 正常なレスポンス形式でのパースを試行し、成功した場合はdataフィールドを永続化層から指定されたValibotスキーマで検証します。
2. **エラーレスポンスのパース**: DB層が返すエラー形式でのパースを試行し、成功した場合はエラー情報を返します。
3. **HTTPステータスコードからのエラー生成**: JSONパースが両方とも失敗した場合、HTTPサーバーやCloudflare等のインフラ層が返したエラーと判断し、ステータスコードに基づいてエラー情報を生成します。

## 提供インターフェース

ネットワーク層は以下の3つのメソッドを提供します:

- `getJson<T>(path: string, schema: Schema<T>): Promise<Result<T>>`
- `postJson(path: string, body: object): Promise<Result<ApiVoid>>`
- `putJson(path: string, body: object): Promise<Result<ApiVoid>>`

## エラー処理

### fetch()が発生する例外

#### AbortError / NotAllowedError (DOMException)

- **要因**: AbortControllerによるリクエストの中止。NotAllowedErrorはトピックAPI関連のためVanishToDoでは発生しません。
- **処理方針**: DeQueueを実行せず、処理を中断します。次回のEnQueue時、またはユーザーによる明示的なリロード時に、Queueの先頭から処理を再開します。
- **ネットワーク層の返却値**: `status: "abort"`

#### TypeError

- **要因**: ネットワークエラー、またはその他の様々な理由で発生します。
- **処理方針**: リトライ対象とします。DeQueueは実行せず、複数回リトライを試行します。リトライ失敗後は処理を中断し、次回のEnQueue時またはユーザーによる明示的なリロード時に処理を再開します。
- **ネットワーク層の返却値**: `status: "recoverable"`
- **懸念事項**: TypeErrorはネットワークエラー以外でも発生します。VanishToDoのロジック異常により発生した場合は回復不可能ですが、ネットワークエラーとその他のエラーを区別する方法が不明なため、現状では一律にリトライ対象としています。この場合Queueがクリアされず、再起動後も動作不能となる可能性があり、フェイルセーフの観点から課題が残ります。

#### 未知の例外

- **処理方針**: 致命的エラーとして扱います。
- **ネットワーク層の返却値**: `status: "fatal"`

### HTTPレスポンスステータスコード

VanishToDoで発生しうるHTTPステータスコードは、以下の3つの層から返されます。

#### Hono本体が返すエラー

| Status | 名称 | 発生条件 | 備考 |
|--------|------|----------|------|
| 404 | Not Found | ルート未定義 | `app.notFound()` で上書き可 |
| 405 | Method Not Allowed | パス一致・メソッド不一致 | バージョンや設定で 404 に退化する場合あり |
| 500 | Internal Server Error | 未ハンドル例外 / Response未返却 | `app.onError()` で上書き可 |

#### Cloudflare Workersが返すエラー

| Status | 名称 | 発生条件 | 捕捉可否 |
|--------|------|----------|----------|
| 400 | Bad Request | リクエスト形式が不正（壊れたHTTP、異常ヘッダ） | ❌ |
| 413 | Payload Too Large | Body サイズが Workers 上限超過 | ❌ |
| 414 | URI Too Long | URL が上限超過 | ❌ |
| 431 | Request Header Fields Too Large | Cookie / Header が大きすぎる | ❌ |
| 500 | Internal Error | Workers エンジン内部エラー | ❌ |
| 503 | Service Unavailable | Workers 側の一時障害 | ❌ |

#### Cloudflare Edgeが返すエラー

| Status | 名称 | 発生条件 | 補足 |
|--------|------|----------|------|
| 403 | Forbidden | WAF / Bot Fight / 地域制限 | Hono 未到達 |
| 429 | Too Many Requests | Rate Limiting / DDoS Protection | Hono 未到達 |
| 522 | Connection Timed Out | オリジン（Workers含む）応答なし | Cloudflare 固有 |
| 523 | Origin Unreachable | オリジン未到達 | 同上 |
| 524 | A Timeout Occurred | Workers 実行時間超過 | 同上 |
| 530 | Origin DNS Error | DNS 解決失敗 | 同上 |

#### DB層が返すエラー

詳細はDB_API_SPECを参照してください。以下は参考情報です。

| エラーコード | HTTPステータス | 説明 |
|--------------|----------------|------|
| VALIDATION_ERROR | 400 | 入力バリデーションエラー |
| NOT_FOUND | 404 | リソースが見つからない |
| CONFLICT | 409 | 楽観的ロック競合 |
| INTERNAL_ERROR | 500 | サーバー内部エラー |
| LLM_UNAVAILABLE | 503 | LLM APIが利用不可 |

### ステータスコードの分類と処理方針

ネットワーク層は、HTTPステータスコードを以下の4つの分類に変換して永続化層に返します。

#### 1. 競合エラー (status: "conflict")

- **該当ステータス**: 409
- **要因**: 楽観的ロック競合。複数箇所からの同時書き込みによりversionフィールドが不一致となった状態です。
- **処理方針**: ユーザーに上書きまたはQueueの破棄を選択させます。

#### 2. 回復可能エラー (status: "recoverable")

- **該当ステータス**: 429, 503, 522, 523, 524, 530
- **要因**: 一時的なネットワーク障害、サーバー過負荷、DNS問題など
- **処理方針**: DeQueueは実行せず、リトライを試行します。複数回のリトライ失敗後は処理を中断し、次回のEnQueue時またはユーザーによる明示的なリロード時に処理を再開します。
- **備考**: 523, 530は暫定的にリトライ対象としていますが、将来的に見直す可能性があります。

#### 3. 致命的エラー (status: "fatal")

- **該当ステータス**: 400, 403, 404, 405, 413, 414, 431, 500
- **要因**: VanishToDoのロジックバグ、または設定・権限の問題
- **処理方針**: 当該アクセスをDeQueueします。リトライしても回復不可能なエラーです。
- **備考**:
  - 400はフロントエンドでバリデーションを実施するため、通常は発生しません。
  - 404, 405, 500はVanishToDoのバグを示唆します。

#### 4. レスポンスパース失敗 (status: "fatal")

- **要因**: サーバーからのレスポンスが想定されたJSON構造と一致しない場合
- **処理方針**: 致命的エラーとして扱い、DeQueueします。
