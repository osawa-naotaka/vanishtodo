# 5.5 ビジネス層機能仕様

## 5.5.1 機能概要


## 5.5.2 機能リスト

| 機能ID | 機能名 | 優先度 | 対応要件ID |
|--------|--------|--------|-----------|
| F-B-001 | 初期化 | 必須 | FR-5.1, 5.2 |
| F-B-002 | タスク読み込み | 必須 | FR-2.1~2.6 |
| F-B-003 | タスク作成 | 必須 | FR-1.1 |
| F-B-004 | タスク更新 | 必須 | FR-3.1, 3.4 |
| F-B-005 | タスク完了 | 必須 | FR-3.3 |
| F-B-006 | タスク削除 | 必須 | FR-3.2, 3.5 |
| F-B-007 | タスク未完了化 | 低 | FR-3.6 |
| F-B-008 | タスク復帰 | 低 | FR-3.7 |
| F-B-009 | 設定読み込み | 必須 | FR-2.1, 2.3 |
| F-B-010 | 設定更新 | 必須 | FR-2.1, 2.3, 4.1 |
| F-B-010 | タスクLLM補完 | 中 | FR-1.2, 1.3, 4.1 |
| F-B-011 | リロード | 高 | なし |

## 5.5.3 シーケンス図

なし。

## 5.5.4 状態遷移図

なし。

## 5.5.5 機能詳細仕様

### F-B-001 初期化

**概要:**

LocalStorageにDBの値を格納します。以降、LocalStorageが最も正しい状態を表します。

初期化に先立ち、未同期Queueにアイテムが存在する場合、それは前回アプリ終了時にネットワーク断などでDB同期（書き込み）が終わっていないことを示します。そのため、まずは未同期QueueのアイテムをDBに書き込み同期します（F-PE-002）。

未同期Queueが空の状態で、本機能はDB層への読み出しアクセスを行い、Settingと全Task[]をLocalStorageに格納します。
Settingが存在しない場合、致命的エラーで終了します。

**起動トリガ:** ビジネス層からの初期化リクエスト

**機能:**

- DB層への読みだしアクセスを行い、タスクリストとセッティングを取得します。
- 取得したデータをLocalStorageに保存します。
- P-FE-002呼び出し: LocalStorage上の未同期Queueに未処理アクセスが残っている場合は、DB層への読み出しアクセスに先立って未同期Queueの未処理アクセスを順に処理します。

**エラー:**

DB層からの応答により以下のエラーを返す。

- 致命的エラー: 
  1. ネットワークエラーのために初期化に失敗し、かつ、LocalStorageにSettingが存在しない
  2. DB層が500を返し（DB層内部ロジックにバグがある）、かつ、LocalStorageにSettingが存在しない
  - Settingは一度は読み込むことが最低限必要になる。存在しない場合はアプリはそれ以上動作できない。
- ネットワークエラー: ネットワークエラーのために初期化に失敗したが、LocalStorageにSettingが存在する
  - LocalStorageに格納されている値を利用してアプリの動作を継続可能。
- サーバー内部エラー: DB層の内部ロジックにバグがあるが、LocalStorageにSettingが存在する
  - LocalStorageに格納されている値を利用してアプリの動作を継続可能。
- 競合エラー: 1個以上のアイテムに関して、バージョンの競合が発生した
  - 競合はDB側を正として解消済み。そのため、そのままアプリの動作を継続可能。

---

---

## 5.4.6 データ型

詳細はtypes.tsを参照。

- タスクリスト: `Task[]`型
- Setting: `UserSettings`型
